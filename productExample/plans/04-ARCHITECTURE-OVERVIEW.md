# Awesome Pizza - Architecture Overview

> Visual architecture guide for the Awesome Pizza demo application

---

## ğŸ›ï¸ High-Level Architecture

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚         Customer/Manager/Driver         â”‚
                    â”‚          (Mobile + Web Apps)            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚ HTTP/REST
                                      â”‚ WebSocket/SSE
                                      â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    Gateway (Port 5000)                          â”‚
    â”‚                   ASP.NET Minimal API                           â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
    â”‚  â”‚   Orders     â”‚  â”‚   Kitchen    â”‚  â”‚  Tracking    â”‚        â”‚
    â”‚  â”‚   API        â”‚  â”‚   API        â”‚  â”‚   SSE        â”‚        â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ IClusterClient
                              â”‚ (Type-safe proxies)
                              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     Quark Actor Cluster                         â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
    â”‚  â”‚   Silo 1     â”‚  â”‚   Silo 2     â”‚  â”‚   Silo N     â”‚        â”‚
    â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚        â”‚
    â”‚  â”‚ OrderActor   â”‚â—„â”€â”¤ KitchenActor â”‚â—„â”€â”¤ DriverActor  â”‚        â”‚
    â”‚  â”‚ ChefActor    â”‚  â”‚ InventoryActorâ”‚ â”‚ RestaurantActâ”‚        â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                  â”‚                  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Redis Cluster    â”‚    â”‚   MQTT Broker      â”‚
         â”‚  (State + Cluster) â”‚    â”‚  (IoT Telemetry)   â”‚
         â”‚   Port 6379        â”‚    â”‚   Port 1883        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚  Driver Devices   â”‚
                                    â”‚  Kitchen IoT      â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Actor Hierarchy & Relationships

```
RestaurantActor (restaurant-{id})
â”‚
â”œâ”€â”€ KitchenActor (kitchen-{id})
â”‚   â”‚
â”‚   â”œâ”€â”€ ChefActor (chef-{id}-1)
â”‚   â”‚   â””â”€â”€ Currently preparing: order-{xyz}
â”‚   â”‚
â”‚   â”œâ”€â”€ ChefActor (chef-{id}-2)
â”‚   â”‚   â””â”€â”€ Currently preparing: order-{abc}
â”‚   â”‚
â”‚   â””â”€â”€ ChefActor (chef-{id}-N)
â”‚       â””â”€â”€ Available
â”‚
â”œâ”€â”€ InventoryActor (inventory-{id})
â”‚   â””â”€â”€ Stock tracking, reminders
â”‚
â””â”€â”€ MetricsAggregator
    â””â”€â”€ Real-time dashboard updates

OrderActor (order-{id})
â”œâ”€â”€ State: OrderState
â”œâ”€â”€ Reminders: StuckOrderCheck
â””â”€â”€ Streams: order-events

DeliveryDriverActor (driver-{id})
â”œâ”€â”€ State: DriverState + GPS
â”œâ”€â”€ Assigned Order: order-{id}
â””â”€â”€ MQTT Topic: pizza/drivers/{id}/location
```

---

## ğŸ”„ Order Lifecycle Flow

```
Customer       Gateway        OrderActor      KitchenActor    ChefActor      DriverActor
   â”‚              â”‚               â”‚                â”‚              â”‚               â”‚
   â”‚â”€â”€CreateOrderâ”€â–ºâ”‚               â”‚                â”‚              â”‚               â”‚
   â”‚              â”‚â”€â”€Createâ”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚              â”‚               â”‚
   â”‚              â”‚               â”‚                â”‚              â”‚               â”‚
   â”‚              â”‚               â”‚â”€â”€Validatedâ”€â”€â”€â”€â–ºâ”‚              â”‚               â”‚
   â”‚              â”‚               â”‚                â”‚â”€â”€Assignâ”€â”€â”€â”€â”€â–ºâ”‚               â”‚
   â”‚              â”‚               â”‚                â”‚              â”‚               â”‚
   â”‚              â”‚               â”‚â—„â”€â”€Preparingâ”€â”€â”€â”€â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
   â”‚              â”‚               â”‚                â”‚              â”‚               â”‚
   â”‚              â”‚               â”‚â—„â”€â”€Bakingâ”€â”€â”€â”€â”€â”€â”€â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
   â”‚              â”‚               â”‚                â”‚              â”‚               â”‚
   â”‚              â”‚               â”‚â—„â”€â”€Readyâ”€â”€â”€â”€â”€â”€â”€â”€â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
   â”‚              â”‚               â”‚                â”‚              â”‚               â”‚
   â”‚              â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€AssignDriverâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚              â”‚               â”‚                â”‚              â”‚               â”‚
   â”‚              â”‚               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€PickedUpâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚              â”‚               â”‚                â”‚              â”‚               â”‚
   â”‚â—„â”€TrackOrderâ”€â”€â”‚â—„â”€SSE Updatesâ”€â”€â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€GPS Updatesâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚              â”‚               â”‚                â”‚              â”‚               â”‚
   â”‚              â”‚               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€Deliveredâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚              â”‚               â”‚                â”‚              â”‚               â”‚
   â”‚â—„â”€Notificationâ”‚               â”‚                â”‚              â”‚               â”‚
```

---

## ğŸ—ºï¸ Data Flow: Real-time Tracking

```
Driver's Device                MQTT Broker              MQTT Bridge              DeliveryDriverActor        OrderActor           Customer
      â”‚                             â”‚                         â”‚                          â”‚                      â”‚                  â”‚
      â”‚â”€â”€GPS Update (lat,lon)â”€â”€â”€â”€â”€â”€â–ºâ”‚                         â”‚                          â”‚                      â”‚                  â”‚
      â”‚                             â”‚â”€â”€Publish Topicâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                          â”‚                      â”‚                  â”‚
      â”‚                             â”‚  pizza/drivers/{id}      â”‚                          â”‚                      â”‚                  â”‚
      â”‚                             â”‚                         â”‚â”€â”€UpdateLocation()â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚                  â”‚
      â”‚                             â”‚                         â”‚                          â”‚â”€â”€UpdateDriverLoc()â”€â”€â–ºâ”‚                  â”‚
      â”‚                             â”‚                         â”‚                          â”‚                      â”‚                  â”‚
      â”‚                             â”‚                         â”‚                          â”‚â”€â”€Publish Streamâ”€â”€â”€â”€â”€â”€â”                  â”‚
      â”‚                             â”‚                         â”‚                          â”‚                      â”‚                  â”‚
      â”‚                             â”‚                         â”‚                          â”‚                      â”‚â—„â”€SSE Connectionâ”€â”€â”‚
      â”‚                             â”‚                         â”‚                          â”‚                      â”‚â”€â”€GPS Updateâ”€â”€â”€â”€â”€â–ºâ”‚
      â”‚                             â”‚                         â”‚                          â”‚                      â”‚                  â”‚
```

---

## ğŸ¢ Multi-Region Deployment

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ US-EAST Region â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚  Gateway 1  â”‚    â”‚   Silo 1    â”‚    â”‚  Redis       â”‚                  â”‚
â”‚  â”‚  (Primary)  â”‚â”€â”€â”€â–ºâ”‚  (Primary)  â”‚â”€â”€â”€â–ºâ”‚  (Primary)   â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚  Gateway 2  â”‚    â”‚   Silo 2    â”‚    â”‚  Redis       â”‚                  â”‚
â”‚  â”‚  (Replica)  â”‚â”€â”€â”€â–ºâ”‚  (Replica)  â”‚â”€â”€â”€â–ºâ”‚  (Replica)   â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ Cross-Region Sync
                                    â”‚ (Actor Routing)
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ US-WEST Region â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚  Gateway 3  â”‚    â”‚   Silo 3    â”‚    â”‚  Redis       â”‚                  â”‚
â”‚  â”‚  (Primary)  â”‚â”€â”€â”€â–ºâ”‚  (Primary)  â”‚â”€â”€â”€â–ºâ”‚  (Primary)   â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ Cross-Region Sync
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ EU-WEST Region â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚  Gateway 4  â”‚    â”‚   Silo 4    â”‚    â”‚  Redis       â”‚                  â”‚
â”‚  â”‚  (Primary)  â”‚â”€â”€â”€â–ºâ”‚  (Primary)  â”‚â”€â”€â”€â–ºâ”‚  (Primary)   â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Security Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Internet                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
                    â”‚   WAF    â”‚ (Rate limiting, DDoS protection)
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                         â”‚
                    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
                    â”‚   LB     â”‚ (Load balancer)
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                â”‚                â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚ Gateway  â”‚     â”‚ Gateway  â”‚    â”‚ Gateway  â”‚
   â”‚ (HTTPS)  â”‚     â”‚ (HTTPS)  â”‚    â”‚ (HTTPS)  â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚               â”‚                â”‚
        â”‚      Internal Network (VPC)   â”‚
        â”‚               â”‚                â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚          Quark Cluster (mTLS)            â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   â”‚  â”‚ Silo 1  â”‚  â”‚ Silo 2  â”‚  â”‚ Silo 3  â”‚  â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚           â”‚           â”‚
     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
     â”‚ Redis   â”‚ â”‚ Redis  â”‚ â”‚ Redis  â”‚
     â”‚ (TLS)   â”‚ â”‚ (TLS)  â”‚ â”‚ (TLS)  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š State Persistence Strategy

```
Actor Activation                State Operations               Redis Storage
      â”‚                              â”‚                              â”‚
      â”‚â”€â”€OnActivateAsync()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                              â”‚
      â”‚                              â”‚â”€â”€LoadStateAsync()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
      â”‚                              â”‚                              â”‚
      â”‚                              â”‚â—„â”€OrderState + ETagâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
      â”‚                              â”‚                              â”‚
      â”‚â”€â”€UpdateStatusAsync()â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                              â”‚
      â”‚                              â”‚â”€â”€SaveStateAsync()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
      â”‚                              â”‚  (with ETag check)           â”‚
      â”‚                              â”‚                              â”‚
      â”‚                              â”‚â—„â”€Success or Conflictâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
      â”‚                              â”‚                              â”‚
      â”‚  (if conflict, retry)        â”‚                              â”‚
      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                              â”‚
      â”‚                              â”‚                              â”‚
```

### Optimistic Concurrency Pattern

```
T1: Read State (ETag: "v1")
T2: Read State (ETag: "v1")

T1: Update State (ETag: "v1" â†’ "v2") âœ… Success
T2: Update State (ETag: "v1" â†’ "v3") âŒ Conflict! (ETag doesn't match)

T2: Retry - Read State (ETag: "v2")
T2: Update State (ETag: "v2" â†’ "v3") âœ… Success
```

---

## ğŸ¯ Actor Placement Strategy

### Consistent Hashing for OrderActor

```
Hash Ring (360Â°)

        0Â° (North)
           â”‚
      order-123
    (hash: 45Â°)
           â”‚
  90Â° â”€â”€â”¬â”€â”€â”´â”€â”€â”¬â”€â”€ Silo 2
        â”‚     â”‚  (60Â°-150Â°)
        â”‚     â”‚
  180Â° â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€ Silo 3
     (South)     (150Â°-240Â°)
        
  270Â° â”€â”€â”€â”€â”€â”€â”€â”€ Silo 1
    (West)     (240Â°-60Â°)


Placement:
- order-123 (hash=45Â°)  â†’ Silo 1 (240Â°-60Â°)
- order-456 (hash=120Â°) â†’ Silo 2 (60Â°-150Â°)
- order-789 (hash=200Â°) â†’ Silo 3 (150Â°-240Â°)
```

### Prefer-Local for DeliveryDriverActor

```
US-East Region          US-West Region
    â”‚                       â”‚
    â”œâ”€ driver-001 â”€â”€â”€â”€â”€â”€â”€â”€â†’ Silo 1 (US-East)
    â”œâ”€ driver-002 â”€â”€â”€â”€â”€â”€â”€â”€â†’ Silo 1 (US-East)
    â”‚
    â””â”€ driver-003 â”€(cross-region)â”€â†’ Silo 3 (US-West)
```

---

## ğŸ”§ Development Workflow

```
Developer Workstation
        â”‚
        â”‚ 1. Edit Code
        â”‚
        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Build    â”‚ (dotnet build)
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
          â”‚ 2. Source Generators Run
          â”‚    - ActorSourceGenerator
          â”‚    - ProxySourceGenerator
          â”‚    - StateSourceGenerator
          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Tests    â”‚ (dotnet test)
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
          â”‚ 3. Unit + Integration Tests
          â”‚
          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Docker    â”‚ (docker-compose up)
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
          â”‚ 4. Local Cluster
          â”‚    - Redis
          â”‚    - MQTT
          â”‚    - Silo
          â”‚    - Gateway
          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Manual   â”‚ (Postman/Browser)
    â”‚   Test     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ Monitoring & Observability

```
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚         Grafana Dashboard           â”‚
                â”‚  (Metrics + Logs + Traces)         â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                 â”‚                 â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚Prometheusâ”‚    â”‚    Loki    â”‚   â”‚   Tempo    â”‚
    â”‚(Metrics) â”‚    â”‚   (Logs)   â”‚   â”‚  (Traces)  â”‚
    â””â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜
         â”‚                â”‚                 â”‚
         â”‚                â”‚                 â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â”‚          OpenTelemetry Collector            â”‚
    â””â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”˜
         â”‚                                    â”‚
         â”‚                                    â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚    Silo 1    â”‚                   â”‚   Gateway  â”‚
    â”‚  (Metrics    â”‚                   â”‚  (Metrics  â”‚
    â”‚   Logs       â”‚                   â”‚   Logs     â”‚
    â”‚   Traces)    â”‚                   â”‚   Traces)  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ Deployment Pipeline

```
GitHub Repo
    â”‚
    â”‚ git push
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GitHub        â”‚
â”‚  Actions       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ 1. Build & Test
     â”‚ 2. AOT Compile
     â”‚ 3. Docker Build
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Container     â”‚
â”‚  Registry      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ Push Images
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Kubernetes    â”‚
â”‚  Cluster       â”‚
â”‚  (or VMs)      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ Deploy Pods
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Running Cluster                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Silo 1 â”‚  â”‚Gateway â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Key Design Patterns

### 1. **Actor Model Pattern**
- Each order/driver/kitchen is an independent actor
- Message-passing for communication
- No shared mutable state

### 2. **Supervision Pattern**
- Parent-child relationships (Restaurant â†’ Kitchen â†’ Chef)
- Failure handling with supervision directives
- Automatic restart on failure

### 3. **Event Sourcing (Lite)**
- Order events published to streams
- State can be reconstructed from events
- Audit trail for compliance

### 4. **CQRS Pattern**
- Commands: CreateOrder, UpdateStatus
- Queries: GetOrder, GetKitchenStatus
- Separate read/write paths

### 5. **Circuit Breaker**
- Protect external services (Redis, MQTT)
- Fail fast on repeated errors
- Automatic recovery

### 6. **Observer Pattern**
- Real-time updates via SSE
- Actors publish state changes
- Subscribers receive notifications

---

## ğŸ“ Learning Resources

### For Understanding This Architecture

1. **Virtual Actors**: Read Orleans documentation
2. **MQTT Protocol**: MQTT.org specification
3. **Redis Clustering**: Redis cluster tutorial
4. **Native AOT**: Microsoft .NET AOT docs
5. **gRPC**: gRPC.io documentation

### Quark-Specific Docs

- `docs/SOURCE_GENERATOR_SETUP.md` - How source generators work
- `docs/ZERO_REFLECTION_ACHIEVEMENT.md` - AOT compatibility
- `docs/PHASE5_STREAMING.md` - Reactive streaming patterns
- `examples/` - Working code examples

---

**Document Version**: 1.0  
**Last Updated**: 2026-01-31  
**Purpose**: Architecture visualization and understanding
